/*
 * grunt-digium-stratos
 *
 *
 * Copyright (c) 2013 Digium
 */

"use strict";

module.exports = function(grunt) {

    // Please see the Grunt documentation for more information regarding task
    // creation: http://gruntjs.com/creating-tasks

    grunt.registerTask('start-selenium-server', 'Start selenium-server.', function() {
        var done = this.async();
        var remote = require('selenium-webdriver/remote');
        var server = new remote.SeleniumServer(__dirname + '/../lib/selenium-server-standalone-2.37.0.jar',
            {
                port: 4444
            }
        );
        grunt.log.writeln('Starting selenium-server...');
        server.start().then(done);
    });

    grunt.registerTask('stop-selenium-server', 'Stopping selenium-server.', function() {
        var done = this.async();
        var remote = require('selenium-webdriver/remote');
        var server = new remote.SeleniumServer(__dirname + '/../lib/selenium-server-standalone-2.37.0.jar',
            {
                port: 4444
            }
        );
        grunt.log.writeln('Stopping selenium-server...');
        server.stop().then(done);
    });

    grunt.registerTask('liftSails', 'Lift a sails app.', function () {
        var done = this.async();
        var cwd = process.cwd();
        process.chdir(grunt.config('stratos.sailsDir'));
        console.log("Starting Sails in:  " + process.cwd(), grunt.config('stratos.sailsPort'));
        require(process.cwd() + '/node_modules/sails').lift({ log: { level: 'verbose' }, port: grunt.config('stratos.sailsPort') || 2000}, function(){
            console.log('do i get this far?');
            process.chdir(cwd);
            done();
        });
    });

    grunt.registerTask('lowerSails', 'Lower sails, if needed.', function (command) {
        var done = this.async();

        if (global.sails) {
            console.log("Lowering sails");
            sails.lower(_.once(function () {
              delete global.sails;
              done();
            }));
        } else {
            done();
        }
    });
};
